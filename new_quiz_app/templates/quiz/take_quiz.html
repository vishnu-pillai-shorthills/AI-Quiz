{% extends "base.html" %}

{% block title %}Daily Quiz - Quiz App{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Quiz Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">
                                <i class="fas fa-brain text-primary me-2"></i>
                                Daily Quiz
                            </h2>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-1"></i>
                                {{ quiz_date }}
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-flex flex-column align-items-md-end">
                                <div class="mb-2">
                                    <span class="badge bg-primary">{{ quiz.questions|length }} Questions</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="saveProgress()">
                                        <i class="fas fa-save me-1"></i>Save Progress
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="showProgress()">
                                        <i class="fas fa-chart-line me-1"></i>Progress
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress mb-4" style="height: 8px;">
                <div class="progress-bar bg-primary" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>

            <!-- Quiz Questions - All Visible in Scrollable Format -->
            <form id="quizForm" method="POST" action="{{ url_for('quiz.submit_quiz', quiz_date=quiz_date) }}">
                <input type="hidden" name="quiz_date" value="{{ quiz_date }}">
                
                <!-- All Questions Container -->
                <div class="questions-container" style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                    {% for question in quiz.questions %}
                    <div class="card border-0 shadow-sm mb-4 question-card" data-question="{{ loop.index }}" id="question-{{ loop.index }}">
                        <div class="card-header bg-white border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <span class="badge bg-primary me-2">{{ loop.index }}</span>
                                    Question {{ loop.index }} of {{ quiz.questions|length }}
                                </h5>
                                <div class="question-status">
                                    <i class="fas fa-circle text-muted" id="status-{{ loop.index }}"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="question-text mb-4">
                                <h6 class="fw-bold">{{ question.question }}</h6>
                            </div>
                            
                            <div class="options-container">
                                {% set q_index0 = loop.index0 %}
                                {% set q_index = loop.index %}
                                {% for key, value in question.options.items() %}
                                <div class="form-check option-item mb-3">
                                    <input class="form-check-input" type="radio" 
                                           name="answers[{{ q_index0 }}]" 
                                           id="q{{ q_index }}_{{ key }}" 
                                           value="{{ key }}"
                                           onchange="updateProgress()"
                                           {% if user_answers.get(q_index0) == key %}checked{% endif %}>
                                    <label class="form-check-label" for="q{{ q_index }}_{{ key }}">
                                        <span class="option-letter">{{ key }}.</span>
                                        <span class="option-text">{{ value }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-success btn-lg" onclick="showSubmitConfirmation()">
                        <i class="fas fa-check me-2"></i>Submit Quiz
                    </button>
                </div>
            </form>

            <!-- Question Navigator -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">
                        <i class="fas fa-th me-2 text-primary"></i>
                        Question Navigator
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row" id="questionNavigator">
                        {% for question in quiz.questions %}
                        <div class="col-md-2 col-sm-3 col-4 mb-2">
                            <button class="btn btn-outline-primary w-100 question-nav-btn" 
                                    data-question="{{ loop.index }}"
                                    onclick="navigateToQuestion({{ loop.index }})">
                                {{ loop.index }}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Submit Quiz
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-question-circle fa-3x text-primary mb-3"></i>
                    <h5>Are you sure you want to submit your quiz?</h5>
                    <p class="text-muted">You won't be able to change your answers after submission.</p>
                </div>
                
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border rounded p-3">
                            <h6 class="text-primary mb-1">{{ quiz.questions|length }}</h6>
                            <small class="text-muted">Total Questions</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-3">
                            <h6 class="text-success mb-1" id="answeredCount">0</h6>
                            <small class="text-muted">Answered</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-3">
                            <h6 class="text-warning mb-1" id="unansweredCount">{{ quiz.questions|length }}</h6>
                            <small class="text-muted">Unanswered</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Review Answers</button>
                <button type="button" class="btn btn-success" onclick="submitQuiz()">
                    <i class="fas fa-check me-1"></i>Submit Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2 text-info"></i>
                    Quiz Progress
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Progress Overview</h6>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-success" id="modalProgressBar" role="progressbar"></div>
                        </div>
                        <p class="text-muted small">
                            <span id="modalAnsweredCount">0</span> of {{ quiz.questions|length }} questions answered
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Question Status</h6>
                        <div class="d-flex flex-wrap gap-2" id="questionStatusList">
                            <!-- Question status indicators will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveProgress()">
                    <i class="fas fa-save me-1"></i>Save Progress
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let totalQuestions = {{ quiz.questions|length }};
let answeredQuestions = new Set();
let autoSaveInterval;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    startAutoSave();
    
    // Pre-select saved answers
    {% if user_answers %}
    {% for question_index, selected_answer in user_answers.items() %}
    const savedInput = document.querySelector('input[name="answers[{{ question_index }}]"][value="{{ selected_answer }}"]');
    if (savedInput) {
        savedInput.checked = true;
    }
    {% endfor %}
    updateProgress();
    {% endif %}
});

function updateProgress() {
    // Count answered questions
    answeredQuestions.clear();
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const questionCard = radio.closest('.question-card');
        const questionNumber = parseInt(questionCard.dataset.question);
        answeredQuestions.add(questionNumber);
    });
    
    // Update progress bar
    const progressPercentage = (answeredQuestions.size / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progressPercentage + '%';
    
    // Update question status indicators
    document.querySelectorAll('.question-status i').forEach((statusIcon, index) => {
        const questionNumber = index + 1;
        statusIcon.className = 'fas fa-circle';
        
        if (answeredQuestions.has(questionNumber)) {
            statusIcon.classList.add('text-success');
        } else {
            statusIcon.classList.add('text-muted');
        }
    });
    
    // Update question navigator
    updateQuestionNavigator();
}

function updateQuestionNavigator() {
    document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
        const questionNumber = index + 1;
        btn.classList.remove('btn-primary', 'btn-success', 'btn-warning');
        
        if (answeredQuestions.has(questionNumber)) {
            btn.classList.add('btn-success');
        } else {
            btn.classList.add('btn-warning');
        }
    });
}

function navigateToQuestion(questionNumber) {
    const questionElement = document.getElementById(`question-${questionNumber}`);
    if (questionElement) {
        questionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function showSubmitConfirmation() {
    // Update modal with current progress
    const progressPercentage = (answeredQuestions.size / totalQuestions) * 100;
    document.getElementById('modalProgressBar').style.width = progressPercentage + '%';
    document.getElementById('modalAnsweredCount').textContent = answeredQuestions.size;
    document.getElementById('answeredCount').textContent = answeredQuestions.size;
    document.getElementById('unansweredCount').textContent = totalQuestions - answeredQuestions.size;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('submitModal')).show();
}

function submitQuiz() {
    // Validate that all questions are answered
    if (answeredQuestions.size < totalQuestions) {
        const unanswered = totalQuestions - answeredQuestions.size;
        if (!confirm(`You have ${unanswered} unanswered question(s). Are you sure you want to submit?`)) {
            return;
        }
    }

    // Ensure latest answers are saved before submitting
    saveProgress().finally(() => {
        document.getElementById('quizForm').submit();
    });
}

function saveProgress() {
    // Collect all answers
    const answers = {};
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const questionCard = radio.closest('.question-card');
        const questionNumber = parseInt(questionCard.dataset.question);
        answers[questionNumber - 1] = radio.value;
    });
    
    // Send to server (return the promise so callers can await)
    return fetch('{{ url_for("quiz.save_progress", quiz_date=quiz_date) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            answers: answers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Progress saved successfully!', 'success');
        } else {
            showNotification('Error saving progress: ' + data.message, 'error');
        }
        return data;
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving progress', 'error');
        throw error;
    });
}

function showProgress() {
    // Populate question status list
    const statusList = document.getElementById('questionStatusList');
    statusList.innerHTML = '';
    
    for (let i = 1; i <= totalQuestions; i++) {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'd-flex align-items-center gap-2 mb-2';
        
        let statusIcon, statusText, statusClass;
        
        if (answeredQuestions.has(i)) {
            statusIcon = 'fas fa-check-circle';
            statusText = 'Answered';
            statusClass = 'text-success';
        } else {
            statusIcon = 'fas fa-circle';
            statusText = 'Unanswered';
            statusClass = 'text-muted';
        }
        
        statusDiv.innerHTML = `
            <i class="${statusIcon} ${statusClass}"></i>
            <span class="small">Question ${i}: ${statusText}</span>
        `;
        
        statusList.appendChild(statusDiv);
    }
    
    // Show modal
    new bootstrap.Modal(document.getElementById('progressModal')).show();
}

function startAutoSave() {
    // Auto-save every 30 seconds
    autoSaveInterval = setInterval(saveProgress, 30000);
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    saveProgress();
});
</script>
{% endblock %} 