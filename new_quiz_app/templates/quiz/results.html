{% extends "base.html" %}

{% block title %}Quiz Results - Quiz App{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Results Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% if score_percentage >= 80 %}
                            <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                            <h2 class="text-success">Excellent!</h2>
                        {% elif score_percentage >= 60 %}
                            <i class="fas fa-medal fa-3x text-info mb-3"></i>
                            <h2 class="text-info">Good Job!</h2>
                        {% elif score_percentage >= 40 %}
                            <i class="fas fa-thumbs-up fa-3x text-primary mb-3"></i>
                            <h2 class="text-primary">Well Done!</h2>
                        {% else %}
                            <i class="fas fa-book fa-3x text-secondary mb-3"></i>
                            <h2 class="text-secondary">Keep Learning!</h2>
                        {% endif %}
                    </div>
                    
                    <h3 class="mb-2">Quiz Results</h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar me-1"></i>
                        {{ quiz_date }}
                    </p>
                </div>
            </div>

            <!-- Score Summary -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="fas fa-percentage fa-2x text-primary"></i>
                            </div>
                            <h4 class="text-primary mb-1">{{ score_percentage }}%</h4>
                            <small class="text-muted">Score</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                            <h4 class="text-success mb-1">{{ correct_answers }}</h4>
                            <small class="text-muted">Correct</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="fas fa-times-circle fa-2x text-danger"></i>
                            </div>
                            <h4 class="text-danger mb-1">{{ incorrect_answers }}</h4>
                            <small class="text-muted">Incorrect</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <div class="mb-3">
                                <i class="fas fa-clock fa-2x text-info"></i>
                            </div>
                            <h4 class="text-info mb-1">{{ time_taken }}</h4>
                            <small class="text-muted">Time Taken</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2 text-primary"></i>
                                Performance Breakdown
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <canvas id="performanceChart" width="200" height="200"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column gap-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success rounded-circle me-3" style="width: 20px; height: 20px;"></div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <span>Correct Answers</span>
                                                    <span class="fw-bold">{{ correct_answers }}/{{ total_questions }}</span>
                                                </div>
                                                <div class="progress mt-1" style="height: 6px;">
                                                    <div class="progress-bar bg-success" style="width: {{ (correct_answers / total_questions) * 100 }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-danger rounded-circle me-3" style="width: 20px; height: 20px;"></div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <span>Incorrect Answers</span>
                                                    <span class="fw-bold">{{ incorrect_answers }}/{{ total_questions }}</span>
                                                </div>
                                                <div class="progress mt-1" style="height: 6px;">
                                                    <div class="progress-bar bg-danger" style="width: {{ (incorrect_answers / total_questions) * 100 }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        {% if unanswered_questions > 0 %}
                                        <div class="d-flex align-items-center">
                                            <div class="bg-warning rounded-circle me-3" style="width: 20px; height: 20px;"></div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <span>Unanswered</span>
                                                    <span class="fw-bold">{{ unanswered_questions }}/{{ total_questions }}</span>
                                                </div>
                                                <div class="progress mt-1" style="height: 6px;">
                                                    <div class="progress-bar bg-warning" style="width: {{ (unanswered_questions / total_questions) * 100 }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Review -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2 text-primary"></i>
                                Question Review
                            </h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="toggleAllAnswers()">
                                    <i class="fas fa-eye me-1"></i>Show All Answers
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="printResults()">
                                    <i class="fas fa-print me-1"></i>Print
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% for question in questions %}
                            <div class="question-review mb-4 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="mb-0">
                                        <span class="badge bg-primary me-2">Q{{ loop.index }}</span>
                                        {{ question.question }}
                                    </h6>
                                    <div class="question-status">
                                        {% if user_answers[loop.index0] == question.answer %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Correct
                                            </span>
                                        {% elif user_answers[loop.index0] %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Incorrect
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-minus me-1"></i>Unanswered
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="options-review">
                                    {% for key, value in question.options.items() %}
                                    <div class="option-item mb-2 p-2 rounded {% if key == question.answer %}bg-success bg-opacity-10 border-success{% elif key == user_answers[loop.index0] and key != question.answer %}bg-danger bg-opacity-10 border-danger{% endif %}">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if key == question.answer %}
                                                    <i class="fas fa-check-circle text-success"></i>
                                                {% elif key == user_answers[loop.index0] and key != question.answer %}
                                                    <i class="fas fa-times-circle text-danger"></i>
                                                {% else %}
                                                    <i class="fas fa-circle text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <span class="fw-bold">{{ key }}.</span>
                                                <span>{{ value }}</span>
                                                {% if key == question.answer %}
                                                    <span class="badge bg-success ms-2">Correct Answer</span>
                                                {% elif key == user_answers[loop.index0] and key != question.answer %}
                                                    <span class="badge bg-danger ms-2">Your Answer</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if question.explanation %}
                                <div class="explanation mt-3 p-3 bg-light rounded">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-lightbulb me-1"></i>Explanation
                                    </h6>
                                    <p class="mb-0">{{ question.explanation }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                            <i class="fas fa-home me-1"></i>Back to Dashboard
                        </a>
                        <a href="{{ url_for('quiz.view_history') }}" class="btn btn-outline-primary">
                            <i class="fas fa-history me-1"></i>View History
                        </a>
                        <button class="btn btn-outline-success" onclick="shareResults()">
                            <i class="fas fa-share me-1"></i>Share Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Results Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share me-2 text-primary"></i>Share Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h5>Share your quiz results!</h5>
                    <p class="text-muted">Let others know about your performance</p>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="shareOnTwitter()">
                        <i class="fab fa-twitter me-2"></i>Share on Twitter
                    </button>
                    <button class="btn btn-outline-primary" onclick="shareOnFacebook()">
                        <i class="fab fa-facebook me-2"></i>Share on Facebook
                    </button>
                    <button class="btn btn-outline-primary" onclick="shareOnLinkedIn()">
                        <i class="fab fa-linkedin me-2"></i>Share on LinkedIn
                    </button>
                    <button class="btn btn-outline-secondary" onclick="copyResultsLink()">
                        <i class="fas fa-link me-2"></i>Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance Chart
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Correct', 'Incorrect', 'Unanswered'],
        datasets: [{
            data: [{{ correct_answers }}, {{ incorrect_answers }}, {{ unanswered_questions }}],
            backgroundColor: [
                '#28a745',
                '#dc3545',
                '#ffc107'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function toggleAllAnswers() {
    const explanations = document.querySelectorAll('.explanation');
    const button = event.target;
    
    if (button.innerHTML.includes('Show')) {
        explanations.forEach(exp => exp.style.display = 'block');
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Answers';
    } else {
        explanations.forEach(exp => exp.style.display = 'none');
        button.innerHTML = '<i class="fas fa-eye me-1"></i>Show All Answers';
    }
}

function printResults() {
    window.print();
}

function shareResults() {
    new bootstrap.Modal(document.getElementById('shareModal')).show();
}

function shareOnTwitter() {
    const text = `I scored {{ score_percentage }}% on today's quiz! 🧠 #QuizApp #Learning`;
    const url = window.location.href;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`);
}

function shareOnFacebook() {
    const url = window.location.href;
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
}

function shareOnLinkedIn() {
    const url = window.location.href;
    const title = 'Quiz Results';
    const summary = `I scored {{ score_percentage }}% on today's quiz!`;
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(summary)}`);
}

function copyResultsLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        showNotification('Link copied to clipboard!', 'success');
    }).catch(() => {
        showNotification('Failed to copy link', 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Hide explanations by default
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.explanation').forEach(exp => {
        exp.style.display = 'none';
    });
});
</script>
{% endblock %} 